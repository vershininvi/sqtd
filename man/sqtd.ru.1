.TH sqtd "1" "11.03.2013" "sqtd" "Пользовательские команды"
.SH ИМЯ
sqtd \- Squid traffic quotation daemon 
.SH СИНТАКСИС
sqtd -c файл [-t] [-d 0|1|2] [-v] [-h]
.SH ОПИСАНИЕ
.B sqtd
предназначен для ограничения интернет траффика пользователя на основе квот, установленных в файле конфигурации программы. Для запуска демона необходимо указать расположение конфигурационного файла (параметр -с командной строки ). Анализ файла лога доступа squid.log  производится периодически, с интервалом указанным в параметре конфигурационного файла CheckInterval (в секундах). В результате проверки формируются два файла списка: список разрешения и список запрета доступа (параметры AllowFile и DenyFile соответсвенно ). Эти списки могут быть использованы в файлах настройки squid squid.conf для разрешения и запрета доступа. После составления списков доступа автоматически выполняется скриптЮ указанный в параметре  ActionScript файла конфигурации sqtd. Резултаты работы протоколируются в файле лога, указанном в параметре  LogFile, либо в системном логе если вместо пути к файлу лога исползовано ключевое слово syslog,  либо в консоль если при запуске указан параметр -t командной строки. В режиме демона (без использования параметра -t командной строки) идентификатор процесса записывается в файл, указанный в параметре PidFile файла конфигурации.
.SH КЛЮЧИ
.TP
\fB\-c файл\fR  
использовать файл конфигурации
.TP
\fB\-d уровень\fR 
установить уровень отладочных сообщений 
.RS
0 \-   только ошибки 
.RE
.RS
1 \-   предупреждениея и ошибки
.RE
.RS
2 \-   сообщения, предупреждения и ошибки
.RE
.TP
\fB\-h\fR
вывод этой справки
.TP
\fB\-v\fR
вывод версии программы
.TP
\fB\-t\fR
запуск в отладочном  режиме с выводом отладочных сообщений в консоль
.SH ВОЗВРАЩАЕМЫЕ ЗНАЧЕНИЯ
.TP
0 \- нормальное завершение работы
.TP
1 \- небольшие проблемы
.TP
2 \- серьёзная проблема
.SH ФАЙЛЫ
.I /etc/sqtd/sqtd.conf 
.RS
файл конфигурации 
.RE
.I/etc/sqtd/action.sh
.RS
shell скрипт, автоматически исполняемый демоном. Используется для процедуры реконфигурации squid
.RE
.I /var/lib/sqtd/access.lst 
.RS
список разрешения  доступа для использования в настройках squid
.RE
.I /var/lib/sqtd/deny.lst
.RS
список запрета доступа для использования в настройках squid
.RE
.I /var/lib/sqtd/sqtd.pid
.RS
файл идентификатора процесса, используется для идентификации прроцесса sqtd при работе в режиме демона ( без использования опции -t) 
.RE
.SH ФАЙЛЫ КОНФИГУРАЦИ
Путь к файлу конфигурации указывается через параметр командной строки -c. Программа обрабатывает файл конфигурации последовательно от начала до конца. Пустые строки игнорируются. Каждая непустая строка файла конфигурации представляет собой пару КЛЮЧ ЗНАЧЕНИЕ. Если ЗНАЧЕНИЕ представляет собой путь к файлу - рекомендуется указывать полный путь.  

.RE
\fBПараметры файла конфигурации:\fR
.TP
\fBCheckInterval число\fR  
количество секунд между процедурами проверок (рекомендуемое значение для отладки - 5, 300 - для рабочего режима). 
.RE
.TP
\fBAccessLogFile файл\fR 
путь к файлу лога squid access.log (/var/log/squid/access.log)
.RE
.TP
\fBAllowFile     файл\fR 
путь к файлу списка  разрешения  доступа для использования в настройках squid (/var/lib/sqtd/allow.lst). Для того чтобы squid учитывал данный файл необходимо в файле конфигурации прокси сервера squid.conf создать соответсвующий список доступа и разрешить доступ по этому списку.Например:

.RS
acl SQTD_ALLOW  proxy_auth -i /var/lib/sqtd/access.lst
.RE
.RS
http_access allow  SQTD_ALLOW
.RE

Поскольку squid обрабатывает правила последовательно от начала до конца, и прекращает проверку при первом же совпадении правила строка http_access allow  SQTD_ALLOW должна находиться ПОСЛЕ строки запрета, учитывающей файл запрета доступа sqtd.
.RE
.TP
\fBDenyFile      файл\fR 
путь к файлу запрета доступа (/var/lib/sqtd/allow.lst) 
Для того чтобы squid учитывал данный файл необходимо в файле конфигурации прокси сервера squid.conf создать соответсвующий список доступа и запретить доступ по этому списку.Например:

.RS
acl SQTD_DENY  proxy_auth -i /var/lib/sqtd/deny.lst
.RE
.RS
http_access deny  SQTD_DENY
.RE

Поскольку squid обрабатывает правила последовательно от начала до конца, и прекращает проверку при первом же совпадении правила строка http_access deny  SQTD_DENY должна находиться перед строкой разрешения, учитывающей файл разрешения доступа sqtd.

.RE
.TP
\fBLogFile файл\fR       
путь к файлу лога (/var/log/sqtd/sqtd.log)
.RE
.TP
\fBActionScript файл\fR 
путь к файлу скрипта (/etc/sqtd/action.sh)
.RE
.TP
\fBPidFile файл\fR 
путь к файлу идентификатора процесса  (/var/lib/sqtd/sqtd.pid)
.RE
.TP
\fBLimit ограничение\fR
Ограничения для пользователей указываются ключевым словом Limit. В качестве значения для ключевого слова Limit используется строка ограничения вида ТИП:ИМЯ:ПЕРИОД:КОЛИЧЕСТВО. Ограничение может быть двух типов - пользовательское  (u) или групповое (g). ИМЯ определяет имя пользователя или группы, на которое распространяется действие данного ограничения. ПЕРИОД - определяет срок действия ограничения и может быть представлен одним из трех значений h (час), d(день) или m (месяц). КОЛИЧЕСТВО указывает объем разрешенного траффика в байтах, килобайтах (K), мегабайтах (M) или гигабайтах (G). Если в качестве КОЛИЧЕСТВА указан 0, то для пользователя или группы  ограничения не используются. Поскольку файл конфигурации обрабатывается последовательно от начала и до конца, на пользователя или группу будет воздействовать самое последнее применимое к нему ограничение на соответсвующий период. Программа получает информацию о пользователях и группах при помощи стандартной системной функции getgrent(). ИМЯ, используемое  должно соответсвовать выводу getent passwd b getent.group. При использовании прокси серывера совместно с MS AD для получения информации о пользователях и грппах из AD необходимо  настроить samba в соответсвии с инструкциями подключения samba к MS AD.
.RE
.SH АВТОРЫ
Программа разработана Вершининым Владимиром Ивановичем 
<vershininvi@rambler.ru>. Россия. Волгоград.
.SH "СМОТРИТЕ ТАКЖЕ"
man getent, man smb.conf, man squid.
